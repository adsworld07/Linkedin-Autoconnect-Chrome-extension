function e(e,t){for(let r in e)t(e[r],r)}function t(e,t){e.forEach(t)}function r(e,t){if(!e)throw Error(t)}function n(e,t){me={parent:me,value:e,template:J(e,'template')||ge(),sidRoot:J(e,'sidRoot')||me&&me.sidRoot};try{return t()}finally{me=U(me)}}function a({node:e=[],from:r,source:n,parent:a=r||n,to:i,target:o,child:l=i||o,scope:s={},meta:f={},family:u={type:'regular'},regional:d}={}){let c=ve(a),p=ve(u.links),m=ve(u.owners),g=[];t(e,(e=>e&&le(g,e)));let h={id:ce(),seq:g,next:ve(l),meta:f,scope:s,family:{type:u.type||"crosslink",links:p,owners:m}};return t(p,(e=>le(L(e),h))),t(m,(e=>le(T(e),h))),t(c,(e=>le(e.next,h))),d&&me&&be(W(me),[h]),h}function i(e,r,n){let a,i=tt,o=null,l=Xe;if(e.target&&(r=e.params,n=e.defer,a=e.meta,i='page'in e?e.page:i,e.stack&&(o=e.stack),l=G(e)||l,e=e.target),l&&Xe&&l!==Xe&&(Xe=null),Array.isArray(e))for(let t=0;t<e.length;t++)Ge('pure',i,V(e[t]),o,r[t],l,a);else Ge('pure',i,V(e),o,r,l,a);if(n&&!Ye)return;let s,f,u,d,c,p,m={isRoot:Ye,currentPage:tt,scope:Xe,isWatch:Ze,isPure:et};Ye=0;e:for(;d=Ue();){let{idx:e,stack:r,type:n}=d;u=r.node,tt=c=r.page,Xe=G(r),c?p=c.reg:Xe&&(p=Xe.reg);let a=!!c,i=!!Xe,o={fail:0,scope:u.scope};s=f=0;for(let t=e;t<u.seq.length&&!s;t++){let l=u.seq[t];if(l.order){let{priority:a,barrierID:i}=l.order,o=i?c?`${c.fullID}_${i}`:i:0;if(t!==e||n!==a){i?Qe.has(o)||(Qe.add(o),Je(t,r,a,i)):Je(t,r,a);continue e}i&&Qe.delete(o)}switch(l.type){case'mov':{let e,t=l.data;switch(t.from){case _:e=W(r);break;case"a":case'b':e=r[t.from];break;case"value":e=t.store;break;case"store":if(p&&!p[t.store.id])if(a){let e=at(c,t.store.id);r.page=c=e,e?p=e.reg:i?(st(Xe,t.store,0,1,t.softRead),p=Xe.reg):p=void 0}else i&&st(Xe,t.store,0,1,t.softRead);e=Ve(p&&p[t.store.id]||t.store)}switch(t.to){case _:r.value=e;break;case"a":case'b':r[t.to]=e;break;case"store":ot(c,Xe,u,t.target).current=e}break}case'compute':let e=l.data;if(e.fn){Ze='watch'===J(u,'op'),et=e.pure;let t=e.safe?(0,e.fn)(W(r),o.scope,r):ft(o,e.fn,r);e.filter?f=!t:r.value=t,Ze=m.isWatch,et=m.isPure}}s=o.fail||f}if(!s){let e=W(r),n=G(r);if(t(u.next,(t=>{Ge('child',c,t,r,e,n)})),n){J(u,'needFxCounter')&&Ge('child',c,n.fxCount,r,e,n),J(u,'storeChange')&&Ge('child',c,n.storeChange,r,e,n),J(u,'warnSerialize')&&Ge('child',c,n.warnSerializeNode,r,e,n);let a=n.additionalLinks[u.id];a&&t(a,(t=>{Ge('child',c,t,r,e,n)}))}}}Ye=m.isRoot,tt=m.currentPage,Xe=G(m)}function o(t,r="combine"){let n=r+'(',a='',i=0;return e(t,(e=>{i<25&&(null!=e&&(n+=a,n+=X(e)?Q(e).fullName:e.toString()),i+=1,a=', ')})),n+')'}function l(e,t){e.shortName=t,Object.assign(Q(e),s(t,U(e)))}function s(e,t){let r,n,a=e;if(t){let a=Q(t);0===e.length?(r=a.path,n=a.fullName):(r=a.path.concat([e]),n=0===a.fullName.length?e:a.fullName+'/'+e)}else r=0===e.length?[]:[e],n=e;return{shortName:a,fullName:n,path:r}}function f(e,t){let r=t?e:e[0];xe(r);let n=r.or,a=r.and;if(a){let r=t?a:a[0];if(ke(r)&&'and'in r){let r=f(a,t);e=r[0],n={...n,...r[1]}}else e=a}return[e,n]}function u(e,...t){let r=ge();if(r){let n=r.handlers[e];if(n)return n(r,...t)}}function d(e,t){let r=ut({or:t,and:'string'==typeof e?{name:e}:e}),n=(e,...t)=>(se(!J(n,'derived'),'call of derived event','createEvent'),se(!et,'unit call from pure function','operators like sample'),tt?((e,t,r,n)=>{let a=tt,i=null;if(t)for(i=tt;i&&i.template!==t;)i=U(i);nt(i);let o=e.create(r,n);return nt(a),o})(n,o,e,t):n.create(e,t)),o=ge(),l=Object.assign(n,{graphite:a({meta:kt("event",n,r),regional:1}),create:e=>(i({target:n,params:e,scope:Xe}),e),watch:e=>bt(n,e),map:e=>wt(n,P,e,[Re()]),filter:e=>wt(n,"filter",e.fn?e:e.fn,[Re(Ae,1)]),filterMap:e=>wt(n,'filterMap',e,[Re(),De((e=>!Se(e)),1)]),prepend(e){let t=d('* \u2192 '+n.shortName,{parent:U(n)});return u('eventPrepend',V(t)),ht(t,n,[Re()],'prepend',e),vt(n,t),t}});return null!=r&&r.domain&&r.domain.hooks.event(l),l}function c(e,n,a,i){return $e(a,n,'first argument'),r(we(i),'second argument should be a function'),se(!J(e,'derived'),`${n} in derived store`,`${n} in store created via createStore`),t(Array.isArray(a)?a:[a],(t=>{e.off(t),H(e).set(t,gt(St(t,e,'on',Me,i)))})),e}function p(e,n){let o=ut(n),l=_e(e),s=d({named:'updates',derived:1});u('storeBase',l);let f=l.id,m={subscribers:new Map,updates:s,defaultState:e,stateRef:l,getState(){let e,t=l;if(tt){let t=tt;for(;t&&!t.reg[f];)t=U(t);t&&(e=t)}return!e&&Xe&&(st(Xe,l,1),e=Xe),e&&(t=e.reg[f]),Ve(t)},setState:e=>i({target:m,params:e,defer:1,scope:Xe}),reset:(...e)=>(t(e,(e=>c(m,'.reset',e,(()=>m.defaultState)))),m),on:(e,t)=>c(m,'.on',e,t),off(e){let t=H(m).get(e);return t&&(t(),H(m).delete(e)),m},map(e,t){let r,n;ke(e)&&(r=e,e=e.fn),se(Se(t),'second argument of store.map','updateFilter');let a=m.getState();ge()?n=null:Se(a)||(n=e(a,t));let i=p(n,{name:`${m.shortName} \u2192 *`,derived:1,and:r}),o=St(m,i,P,Ce,e);return Le(B(i),{type:P,fn:e,from:l}),B(i).noInit=1,u('storeMap',l,o),i},watch(e,t){if(!t||!X(e)){let t=bt(m,e);return u('storeWatch',l,e)||e(m.getState()),t}return r(we(t),'second argument should be a function'),e.watch((e=>t(m.getState(),e)))}},g=kt("store",m,o),h=m.defaultConfig.updateFilter;m.graphite=a({scope:{state:l,fn:h},node:[De(((e,t,r)=>(r.scope&&!r.scope.reg[l.id]&&(r.b=1),e))),Ee(l),De(((e,t,{a:r,b:n})=>!Se(e)&&(e!==r||n)),1),h&&Re(Ce,1),Ne({from:_,target:l})],child:s,meta:g,regional:1});let y=J(m,'serialize'),b=J(m,'derived'),v='ignore'===y,k=!y||v?0:y,w=J(m,'sid');return w&&(K(m,'storeChange',1),l.sid=w,k&&(l.meta={...null==l?void 0:l.meta,serialize:k})),w||v||b||K(m,'warnSerialize',1),r(b||!Se(e),"current state can't be undefined, use null instead"),be(m,[s]),null!=o&&o.domain&&o.domain.hooks.store(m),b||(m.reinit=d(),m.reset(m.reinit)),m}function m(...e){let t,n,a;[e,a]=f(e);let i,o,l,s=e[e.length-1];if(we(s)?(n=e.slice(0,-1),t=s):n=e,1===n.length){let e=n[0];Z(e)||(i=e,o=1)}if(!o&&(i=n,t)){l=1;let e=t;t=t=>e(...t)}return r(ke(i),'shape should be an object'),xt(Array.isArray(i),!l,i,a,t)}function g(...e){return se(0,'createStoreObject','combine'),m(...e)}function h(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function y(e,t){let n=ut(we(e)?{handler:e}:e,t),o=d(we(e)?{handler:e}:e,t),l=V(o);K(l,'op',o.kind="effect"),o.use=e=>(r(we(e),'.use argument should be a function'),g.scope.handler=e,o),o.use.getCurrent=()=>g.scope.handler;let s=o.finally=d({named:'finally',derived:1}),f=o.done=s.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),u=o.fail=s.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),c=o.doneData=f.map({named:'doneData',fn:({result:e})=>e}),m=o.failData=u.map({named:'failData',fn:({error:e})=>e}),g=a({scope:{handlerId:J(l,'sid'),handler:o.defaultConfig.handler||(()=>r(0,`no handler used in ${o.getType()}`))},node:[De(((e,t,r)=>{let n=t,a=n.handler;if(G(r)){let e=G(r).handlers[n.handlerId];e&&(a=e)}return e.handler=a,e}),0,1),De((({params:e,req:t,handler:r,args:n=[e]},a,i)=>{let o=$t(i),l=jt(e,t,1,s,i,o),f=jt(e,t,0,s,i,o),[u,d]=zt(r,f,n);u&&(ke(d)&&we(d.then)?d.then(l,f):l(d))}),0,1)],meta:{op:'fx',fx:'runner'}});l.scope.runner=g,le(l.seq,De(((e,{runner:t},r)=>{let n=U(r)?{params:e,req:{rs(e){},rj(e){}}}:e;return r.meta||(r.meta={fxID:pe()}),i({target:t,params:n,defer:1,scope:G(r),meta:r.meta}),n.params}),0,1)),o.create=e=>{let t=h(),r={params:e,req:t};if(Xe&&!Ze){let e=Xe;t.req.finally((()=>{rt(e)})).catch((()=>{}))}return i({target:o,params:r,scope:Xe}),t.req};let y=o.inFlight=p(0,{serialize:'ignore'}).on(o,(e=>e+1)).on(s,(e=>e-1)).map({fn:e=>e,named:'inFlight'});K(s,'needFxCounter','dec'),K(o,'needFxCounter',1);let b=o.pending=y.map({fn:e=>e>0,named:'pending'});return be(o,[s,f,u,c,m,b,y]),null!=n&&n.domain&&n.domain.hooks.effect(o),o}function b(e){let t;[e,t]=f(e,1);let{source:r,effect:n,mapParams:a}=e,o=y(e,t);K(o,'attached',1);let l,{runner:u}=V(o).scope,d=De(((e,t,n)=>{let l,{params:s,req:f,handler:u}=e,d=o.finally,c=$t(n),p=jt(s,f,0,d,n,c),m=n.a,g=te(u),h=1;if(a?[h,l]=zt(a,p,[s,m]):l=r&&g?m:s,h){if(!g)return e.args=[m,l],1;i({target:u,params:{params:l,req:{rs:jt(s,f,1,d,n,c),rj:p}},page:n.page,defer:1,meta:n.meta})}}),1,1);if(r){let e;Z(r)?(e=r,be(e,[o])):(e=m(r),be(o,[e])),l=[Ee(B(e)),d]}else l=[d];u.seq.splice(1,0,...l),o.use(n);let c=U(n);return c&&(Object.assign(Q(o),s(o.shortName,c)),o.defaultConfig.parent=c),vt(n,o,"effect"),o}function v(...t){let[[r,n],a]=f(t),i={};return e(n,((e,t)=>{let n=i[t]=d(t,{parent:U(r),config:a});r.on(n,e),vt(r,n)})),i}function k(r,n){let o=ut({or:n,and:'string'==typeof r?{name:r}:r}),l=a({family:{type:"domain"},regional:1,parent:(null==o?void 0:o.domain)||(null==o?void 0:o.parent)}),s={history:{},graphite:l,hooks:{}};l.meta=kt("domain",s,{parent:(null==o?void 0:o.domain)||(null==o?void 0:o.parent),or:o}),e({Event:d,Effect:y,Store:p,Domain:k},((e,r)=>{let n=r.toLowerCase(),a=d({named:`on${r}`});s.hooks[n]=a;let o=new Set;s.history[`${n}s`]=o,a.create=e=>(i(a,e),e),le(V(a).seq,De(((e,t,r)=>(r.scope=null,e)))),a.watch((e=>{be(s,[e]),o.add(e),e.ownerSet||(e.ownerSet=o),U(e)||(e.parent=s)})),be(s,[a]),s[`onCreate${r}`]=e=>(t(o,e),a.watch(e)),s[`create${r}`]=s[n]=(t,r)=>{let n=ut({and:r,or:t});return null!=n&&n.domain?e(t,r):a(e(t,{parent:s,or:n}))}}));let f=U(s);return f&&e(s.hooks,((e,t)=>ht(e,f.hooks[t]))),null!=o&&o.domain&&o.domain.hooks.domain(s),s}function w(e){xe(e);let t=R in e?e[R]():e;r(t.subscribe,'expect observable to have .subscribe');let n=d(),a=gt(n);return t.subscribe({next:n,error:a,complete:a}),n}function S(e,t){$e(e,'merge','first argument');let r=d({name:o(e,'merge'),derived:1,and:t});return ht(e,r,[],'merge'),r}function x(e,n){let a=0;return t(Mt,(t=>{t in e&&(r(null!=e[t],At(n,t)),a=1)})),a}function z(...e){let t,r,n,a,[[i,o,l],s]=f(e),u=1;return Se(o)&&ke(i)&&x(i,"sample")&&(o=i.clock,l=i.fn,u=!i.greedy,a=i.filter,t=i.target,r=i.name,n=i.sid,i=i.source),It("sample",o,i,a,t,l,r,s,u,1,0,n)}function $(...e){let[[t,r],n]=f(e);return r||(r=t,t=r.source),x(r,'guard'),It('guard',r.clock,t,r.filter,r.target,null,r.name,n,!r.greedy,0,1)}function j(t,r,n){if(Z(t))return se(0,'restore($store)'),t;if(ee(t)||te(t)){let e=U(t),a=p(r,{parent:e,name:t.shortName,and:n});return ht(te(t)?t.doneData:t,a),e&&e.hooks.store(a),a}let a=Array.isArray(t)?[]:{};return e(t,((e,t)=>a[t]=Z(e)?e:p(e,{name:t}))),a}function C(...t){let n,i,o='split',[[l,s],c]=f(t),p=!s;p&&(n=l.cases,s=l.match,i=l.clock,l=l.source);let m=Z(s),g=!X(s)&&we(s),h=!m&&!g&&ke(s);r(X(l),'source must be a unit'),n||(n={}),p?e(n,((e,t)=>je(o,e,`cases.${t}`))):(r(h,'match should be an object'),e(s,((e,t)=>n[t]=d({derived:1,and:c}))),n.__=d({derived:1,and:c}));let y,b=new Set([].concat(l,i||[],Object.values(n))),v=Object.keys(m||g?n:s);if(m||g)m&&b.add(s),y=[m&&Ee(B(s),0,1),Oe({safe:m,filter:1,pure:!m,fn(e,t,r){let n=String(m?r.a:s(e));Ot(t,ie(v,n)?n:'__',e,r)}})];else if(h){let t=_e({});t.type='shape';let r,n=[];e(s,((e,a)=>{if(X(e)){r=1,le(n,a),b.add(e);let i=ht(e,[],[Ee(t),De(((e,t,{a:r})=>r[a]=e))]);if(Z(e)){t.current[a]=e.getState();let r=B(e);Le(t,{from:r,field:a,type:'field'}),u('splitMatchStore',r,i)}}})),r&&u('splitBase',t),y=[r&&Ee(t,0,1),Re(((e,t,r)=>{for(let a=0;a<v.length;a++){let i=v[a];if(ie(n,i)?r.a[i]:s[i](e))return void Ot(t,i,e,r)}Ot(t,'__',e,r)}),1)]}else r(0,'expect match to be unit, function or object');let k=a({meta:{op:o},parent:i?[]:l,scope:n,node:y,family:{owners:Array.from(b)},regional:1});if(i&&It(o,i,l,null,k,null,o,c,0,0,0),!p)return n}function M(e,{scope:t,params:r}={}){if(!X(e))return Promise.reject(new Error('first argument should be unit'));if(!(te(e)||ee(e)||Z(e)||ne(e)))return Promise.reject(new Error('first argument accepts only effects, events, stores or scopes'));ne(e)&&(t=e);let n=h();n.parentFork=Xe;let{fxCount:a}=t;le(a.scope.defers,n);let o=[],l=[];return ne(e)||(le(o,e),le(l,te(e)?{params:r,req:{rs(e){n.value={status:'done',value:e}},rj(e){n.value={status:'fail',value:e}}}}:r)),le(o,a),le(l,null),i({target:o,params:l,scope:t}),n.req}function A(e,r){let n=[];(function e(a){ie(n,a)||(le(n,a),"store"===J(a,'op')&&J(a,'sid')&&r(a,J(a,'sid')),t(a.next,e),t(L(a),e),t(T(a),e))})(e)}function I(e,n){let a=Array.isArray(e)?new Map(e):e;if(a instanceof Map){let e={};return t(a,((t,a)=>{r(X(a),'Map key should be a unit'),n&&n(a,t),r(a.sid,'unit should have a sid'),r(!(a.sid in e),'duplicate sid found'),e[a.sid]=t})),e}return a}function q(e,n){let i,o=e;re(e)&&(i=e,o=n);let l=(e=>{let r=a({scope:{defers:[],inFlight:0,fxID:0},node:[De(((e,t,r)=>{U(r)?'dec'===J(U(r).node,'needFxCounter')?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1})),Oe({priority:"sampler",batch:1}),De(((e,r)=>{let{defers:n,fxID:a}=r;r.inFlight>0||0===n.length||Promise.resolve().then((()=>{r.fxID===a&&t(n.splice(0,n.length),(e=>{rt(e.parentFork),e.rs(e.value)}))}))}),0,1)]}),n=a({node:[De(((e,t,r)=>{let n=U(r);if(n){let t=n.node;if(!J(t,'isCombine')||U(n)&&'combine'!==J(U(n).node,'op')){let n=G(r),a=t.scope.state.id,i=J(t,'sid');n.sidIdMap[i]=a,n.sidValuesMap[i]=e;let o=J(t,'serialize');o&&n.sidSerializeSettings.set(i,'ignore'===o?{ignore:1}:{ignore:0,write:o.write})}}}))]}),i=a({node:[De(((e,t,r)=>{let n=G(r);if(n){let e=U(r);e&&(!J(e.node,'isCombine')||U(e)&&'combine'!==J(U(e).node,'op'))&&(n.warnSerialize=1)}}))]}),o={cloneOf:e,reg:{},sidValuesMap:{},sidIdMap:{},sidSerializeSettings:new Map,getState(e){if('current'in e)return ot(tt,o,null,e).current;let t=V(e);return ot(tt,o,t,t.scope.state,1).current},kind:"scope",graphite:a({family:{type:"domain",links:[r,n,i]},meta:{unit:'fork'},scope:{forkInFlightCounter:r}}),additionalLinks:{},handlers:{},fxCount:r,storeChange:n,warnSerializeNode:i,activeEffects:[]};return o})(i);if(o){let e=o.scope;if(e){let r=e.activeEffects;e.activeEffects=[],l.activeEffects=r,t(r,(e=>e.ref=l))}if(o.values){let e=I(o.values,(e=>r(Z(e),'Values map can contain only stores as keys')));Object.assign(l.sidValuesMap,e),l.fromSerialize=!(Array.isArray(o.values)||o.values instanceof Map)}o.handlers&&(l.handlers=I(o.handlers,(e=>r(te(e),"Handlers map can contain only effects as keys"))))}return l}function N(e,{values:t}){r(ke(t),'values property should be an object');let n,a,o,l=I(t),s=Object.getOwnPropertyNames(l),f=[],u=[];ne(e)?(n=e,o=1,r(n.cloneOf,'scope should be created from domain'),a=V(n.cloneOf)):re(e)?a=V(e):r(0,'first argument of hydrate should be domain or scope'),A(a,((e,t)=>{if(ie(s,t)){le(f,e);let r=J(e,'serialize');r&&'ignore'!==r&&(l[t]=r.read(l[t])),le(u,l[t])}})),i({target:f,params:u,scope:n}),o&&Object.assign(n.sidValuesMap,l)}function O(e,{scope:t,safe:n}={}){r(t||Xe||n,'scopeBind cannot be called outside of forked .watch');let a=t||Xe;return te(e)?t=>{let r=h();return i({target:e,params:{params:t,req:r},scope:a}),r.req}:t=>(i({target:e,params:t,scope:a}),t)}function F(t,n={}){t.warnSerialize&&console.error('There is a store without sid in this scope, its value is omitted');let a=n.ignore?n.ignore.map((({sid:e})=>e)):[],i={};return e(t.sidValuesMap,((e,r)=>{var n;if(ie(a,r))return;let o=t.sidIdMap[r],l=null!==(n=t.sidSerializeSettings.get(r))&&void 0!==n?n:{ignore:0,write:Dt};l.ignore||(i[r]=(0,l.write)(o&&o in t.reg?t.reg[o].current:e))})),'onlyChanges'in n&&!n.onlyChanges&&(r(t.cloneOf,'scope should be created from domain'),A(V(t.cloneOf),((e,r)=>{r in i||ie(a,r)||J(e,'isCombine')||'ignore'===J(e,'serialize')||(i[r]=t.getState(e))}))),i}function D({unit:e,fn:t,scope:r}){let n=[Pe.run({fn:e=>t(e)})];if(r){let t=a({node:n}),i=e.graphite.id,o=r.additionalLinks,l=o[i]||[];return o[i]=l,l.push(t),E((()=>{let e=l.indexOf(t);-1!==e&&l.splice(e,1),mt(t)}))}{let t=a({node:n,parent:[e],family:{owners:e}});return E((()=>{mt(t)}))}}function E(e){let t=()=>e();return t.unsubscribe=()=>e(),t}let R='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',P='map',_='stack',V=e=>e.graphite||e,L=e=>e.family.owners,T=e=>e.family.links,B=e=>e.stateRef,W=e=>e.value,H=e=>e.subscribers,U=e=>e.parent,G=e=>e.scope,J=(e,t)=>V(e).meta[t],K=(e,t,r)=>V(e).meta[t]=r,Q=e=>e.compositeName,X=e=>(we(e)||ke(e))&&'kind'in e;const Y=e=>t=>X(t)&&t.kind===e;let Z=Y("store"),ee=Y("event"),te=Y("effect"),re=Y("domain"),ne=Y("scope");var ae={__proto__:null,unit:X,store:Z,event:ee,effect:te,domain:re,scope:ne,attached:e=>te(e)&&1==J(e,'attached')};let ie=(e,t)=>e.includes(t),oe=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)},le=(e,t)=>e.push(t),se=(e,t,r)=>!e&&console.error(`${t} is deprecated${r?`, use ${r} instead`:''}`);const fe=()=>{let e=0;return()=>""+ ++e};let ue=fe(),de=fe(),ce=fe(),pe=fe(),me=null,ge=()=>me&&me.template,he=e=>(e&&me&&me.sidRoot&&(e=`${me.sidRoot}|${e}`),e),ye=({sid:e,name:t,loc:r,method:i,fn:o})=>n(a({meta:{sidRoot:he(e),name:t,loc:r,method:i}}),o),be=(e,r)=>{let n=V(e);t(r,(e=>{let t=V(e);"domain"!==n.family.type&&(t.family.type="crosslink"),le(L(t),n),le(T(n),t)}))},ve=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(V),ke=e=>'object'==typeof e&&null!==e,we=e=>'function'==typeof e,Se=e=>void 0===e,xe=e=>r(ke(e)||we(e),'expect first argument be an object');const ze=(e,t,n,a)=>r(!(!ke(e)&&!we(e)||!('family'in e)&&!('graphite'in e)),`${t}: expect ${n} to be a unit (store, event or effect)${a}`);let $e=(e,r,n)=>{Array.isArray(e)?t(e,((e,t)=>ze(e,r,`${t} item of ${n}`,''))):ze(e,r,n,' or array of units')},je=(e,r,n="target")=>t(ve(r),(t=>se(!J(t,'derived'),`${e}: derived unit in "${n}"`,"createEvent/createStore"))),Ce=(e,{fn:t},{a:r})=>t(e,r),Me=(e,{fn:t},{a:r})=>t(r,e),Ae=(e,{fn:t})=>t(e);const Ie=(e,t,r,n)=>{let a={id:de(),type:e,data:t};return r&&(a.order={priority:r},n&&(a.order.barrierID=++qe)),a};let qe=0,Ne=({from:e="store",store:t,target:r,to:n=(r?"store":_),batch:a,priority:i})=>Ie('mov',{from:e,store:t,to:n,target:r},i,a),Oe=({fn:e,batch:t,priority:r,safe:n=0,filter:a=0,pure:i=0})=>Ie('compute',{fn:e,safe:n,filter:a,pure:i},r,t),Fe=({fn:e})=>Oe({fn:e,priority:"effect"}),De=(e,t,r)=>Oe({fn:e,safe:1,filter:t,priority:r&&"effect"}),Ee=(e,t,r)=>Ne({store:e,to:t?_:"a",priority:r&&"sampler",batch:1}),Re=(e=Ae,t)=>Oe({fn:e,pure:1,filter:t}),Pe={mov:Ne,compute:Oe,filter:({fn:e,pure:t})=>Oe({fn:e,filter:1,pure:t}),run:Fe},_e=e=>({id:de(),current:e}),Ve=({current:e})=>e,Le=(e,t)=>{e.before||(e.before=[]),le(e.before,t)},Te=null;const Be=(e,t)=>{if(!e)return t;if(!t)return e;let r;return(e.v.type===t.v.type&&e.v.id>t.v.id||Ke(e.v.type)>Ke(t.v.type))&&(r=e,e=t,t=r),r=Be(e.r,t),e.r=e.l,e.l=r,e},We=[];let He=0;for(;He<6;)le(We,{first:null,last:null,size:0}),He+=1;const Ue=()=>{for(let e=0;e<6;e++){let t=We[e];if(t.size>0){if(3===e||4===e){t.size-=1;let e=Te.v;return Te=Be(Te.l,Te.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Ge=(e,t,r,n,a,i,o)=>Je(0,{a:null,b:null,node:r,parent:n,value:a,page:t,scope:i,meta:o},e),Je=(e,t,r,n=0)=>{let a=Ke(r),i=We[a],o={v:{idx:e,stack:t,type:r,id:n},l:null,r:null};3===a||4===a?Te=Be(Te,o):(0===i.size?i.first=o:i.last.r=o,i.last=o),i.size+=1},Ke=e=>{switch(e){case'child':return 0;case'pure':return 1;case'read':return 2;case"barrier":return 3;case"sampler":return 4;case"effect":return 5;default:return-1}},Qe=new Set;let Xe,Ye=1,Ze=0,et=0,tt=null,rt=e=>{Xe=e},nt=e=>{tt=e};const at=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=U(e);if(e)return e}return null};let ot=(e,t,r,n,a)=>{let i=at(e,n.id);return i?i.reg[n.id]:t?(st(t,n,a),t.reg[n.id]):n};const lt=e=>e;let st=(e,r,n,a,i)=>{var o;let l=e.reg,s=r.sid,f=null==r||null===(o=r.meta)||void 0===o?void 0:o.serialize;if(l[r.id])return;let u={id:r.id,current:r.current,meta:r.meta};if(s&&s in e.sidValuesMap&&!(s in e.sidIdMap))u.current=(e.fromSerialize&&'ignore'!==f&&(null==f?void 0:f.read)||lt)(e.sidValuesMap[s]);else if(r.before&&!i){let i=0,o=n||!r.noInit||a;t(r.before,(t=>{switch(t.type){case P:{let r=t.from;if(r||t.fn){r&&st(e,r,n,a);let i=r&&l[r.id].current;o&&(u.current=t.fn?t.fn(i):i)}break}case'field':i||(i=1,u.current=Array.isArray(u.current)?[...u.current]:{...u.current}),st(e,t.from,n,a),o&&(u.current[t.field]=l[l[t.from.id].id].current)}}))}s&&(e.sidIdMap[s]=r.id),l[r.id]=u};const ft=(e,t,r)=>{try{return t(W(r),e.scope,r)}catch(t){console.error(t),e.fail=1}};let ut=(t,r={})=>(ke(t)&&(ut(t.or,r),e(t,((e,t)=>{Se(e)||'or'===t||'and'===t||(r[t]=e)})),ut(t.and,r)),r);const dt=(e,t)=>{oe(e.next,t),oe(L(e),t),oe(T(e),t)},ct=(e,t,r)=>{let n;e.next.length=0,e.seq.length=0,e.scope=null;let a=T(e);for(;n=a.pop();)dt(n,e),(t||r&&'sample'!==J(e,'op')||"crosslink"===n.family.type)&&ct(n,t,'on'!==J(n,'op')&&r);for(a=L(e);n=a.pop();)dt(n,e),r&&"crosslink"===n.family.type&&ct(n,t,'on'!==J(n,'op')&&r)},pt=e=>e.clear();let mt=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),Z(e))pt(H(e));else if(re(e)){r=1;let t=e.history;pt(t.events),pt(t.effects),pt(t.stores),pt(t.domains)}ct(V(e),!!t,r)},gt=e=>{let t=()=>mt(e);return t.unsubscribe=t,t},ht=(e,t,r,n,i)=>a({node:r,parent:e,child:t,scope:{fn:i},meta:{op:n},family:{owners:[e,t],links:t},regional:1}),yt=e=>{let t='forward',[{from:r,to:n},i]=f(e,1);return $e(r,t,'"from"'),$e(n,t,'"to"'),je(t,n,'to'),gt(a({parent:r,child:n,meta:{op:t,config:i},family:{},regional:1}))},bt=(e,t)=>(r(we(t),'.watch argument should be a function'),gt(a({scope:{fn:t},node:[Fe({fn:Ae})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))),vt=(e,t,r="event")=>{U(e)&&U(e).hooks[r](t)},kt=(e,t,r)=>{let n=ut(r),a="domain"===e,i=ue(),{sid:o=null,named:l=null,domain:f=null,parent:u=f}=n,d=l||n.name||(a?'':i),c=s(d,u),p={op:t.kind=e,name:t.shortName=d,sid:t.sid=he(o),named:l,unitId:t.id=i,serialize:n.serialize,derived:n.derived,config:n};if(t.parent=u,t.compositeName=c,t.defaultConfig=n,t.thru=e=>(se(0,'thru','js pipe'),e(t)),t.getType=()=>c.fullName,!a){t.subscribe=e=>(xe(e),t.watch(we(e)?e:t=>e.next&&e.next(t))),t[R]=()=>t;let e=ge();e&&(p.nativeTemplate=e)}return p};const wt=(e,t,r,n)=>{let a;ke(r)&&(a=r,r=r.fn);let i=d({name:`${e.shortName} \u2192 *`,derived:1,and:a});return ht(e,i,n,t,r),i},St=(e,t,r,n,a)=>{let i=B(t),o=Ne({store:i,to:"a",priority:'read'});r===P&&(o.data.softRead=1);let l=[o,Re(n)];return u('storeOnMap',i,l,Z(e)&&B(e)),ht(e,t,l,r,a)},xt=(t,n,a,i,l)=>{let s=t?e=>[...e]:e=>({...e}),f=t?[]:{},d=s(f),c=_e(d),m=_e(1);c.type=t?'list':'shape',c.noInit=1,u('combineBase',c,m);let g=p(d,{name:o(a),derived:1,and:i}),h=B(g);h.noInit=1,K(g,'isCombine',1);let y=Ee(c);y.order={priority:'barrier'};let b=[De(((e,t,r)=>(r.scope&&!r.scope.reg[c.id]&&(r.c=1),e))),y,Ne({store:m,to:'b'}),De(((e,{key:t},r)=>{if(r.c||e!==r.a[t])return n&&r.b&&(r.a=s(r.a)),r.a[t]=e,1}),1),Ne({from:"a",target:c}),Ne({from:"value",store:0,target:m}),Ne({from:"value",store:1,target:m,priority:"barrier",batch:1}),Ee(c,1),l&&Re()];return e(a,((e,t)=>{if(!Z(e))return r(!X(e)&&!Se(e),`combine expects a store in a field ${t}`),void(d[t]=f[t]=e);f[t]=e.defaultState,d[t]=e.getState();let n=ht(e,g,b,'combine',l);n.scope.key=t;let a=B(e);Le(c,{type:'field',field:t,from:a}),u('combineField',a,n)})),g.defaultShape=a,Le(h,{type:P,from:c,fn:l}),ge()||(g.defaultState=l?h.current=l(d):f),g};let zt=(e,t,r)=>{try{return[1,e(...r)]}catch(e){return t(e),[0,null]}},$t=e=>{let t=G(e),r={ref:t};return t&&le(t.activeEffects,r),r},jt=(e,t,r,n,a,o)=>l=>{o.ref&&oe(o.ref.activeEffects,o),i({target:[n,Ct],params:[r?{status:'done',params:e,result:l}:{status:'fail',params:e,error:l},{value:l,fn:r?t.rs:t.rj}],defer:1,page:a.page,scope:o.ref,meta:a.meta})};const Ct=a({node:[Fe({fn:({fn:e,value:t})=>e(t)})],meta:{op:'fx',fx:'sidechain'}}),Mt=['source','clock','target'],At=(e,t)=>e+`: ${t} should be defined`;let It=(e,t,n,a,i,o,l,s,f,c,g,h)=>{let y=!!i;r(!Se(n)||!Se(t),At(e,'either source or clock'));let b=0;Se(n)?b=1:X(n)||(n=m(n)),Se(t)?t=n:($e(t,e,'clock'),Array.isArray(t)&&(t=S(t))),b&&(n=t),s||l||(l=n.shortName);let v='none';(g||a)&&(X(a)?v='unit':(r(we(a),'`filter` should be function or unit'),v='fn')),i?($e(i,e,'target'),je(e,i)):'none'===v&&c&&Z(n)&&Z(t)?i=p(o?o(Ve(B(n)),Ve(B(t))):Ve(B(n)),{name:l,sid:h,or:s}):(i=d({name:l,derived:1,or:s}),u('sampleTarget',V(i)));let k=_e(),w=[];if('unit'===v){let[r,n]=Nt(a,i,t,k,e);w=[...qt(n),...qt(r)]}let[x,z]=Nt(n,i,t,k,e),$=ht(t,i,[u('sampleSourceLoader'),Ne({from:_,target:k}),...qt(z),Ee(x,1,f),...w,Ee(k),'fn'===v&&Re(((e,t,{a:r})=>a(e,r)),1),o&&Re(Ce),u('sampleSourceUpward',y)],e,o);return be(n,[$]),Object.assign($.meta,s,{joint:1}),i};const qt=e=>[Ee(e),De(((e,t,{a:r})=>r),1)],Nt=(e,t,r,n,i)=>{let o=Z(e),l=o?B(e):_e(),s=_e(o);return o||a({parent:e,node:[Ne({from:_,target:l}),Ne({from:"value",store:1,target:s})],family:{owners:[e,t,r],links:t},meta:{op:i},regional:1}),u('sampleSource',s,l,n),[l,s]},Ot=(e,t,r,n)=>{let a=e[t];a&&i({target:a,params:Array.isArray(a)?a.map((()=>r)):r,defer:1,stack:n})},Ft="22.5.2",Dt=e=>e;export{M as allSettled,b as attach,mt as clearNode,m as combine,v as createApi,k as createDomain,y as createEffect,d as createEvent,a as createNode,p as createStore,g as createStoreObject,D as createWatch,q as fork,yt as forward,w as fromObservable,$ as guard,N as hydrate,ae as is,i as launch,S as merge,j as restore,z as sample,O as scopeBind,F as serialize,l as setStoreName,C as split,Pe as step,Ft as version,ye as withFactory,n as withRegion};
//# sourceMappingURL=effector.mjs.map
